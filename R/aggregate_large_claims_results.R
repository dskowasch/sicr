#' Aggregating data and simulation results to payments and reserves matrices
#'
#' @description
#' This function converts the simulation results and the associated data into payments and reserves matrices.
#'
#'
#' @param sim_result Numeric array as a result of [sicr()].
#' @param large_claims_list Dataframe with one row per known large claim generated by [generate_claims_list()].
#' @param large_extended_claims_data Prepared claims data dataframe, see details of [prepare_data()].
#' @param history numeric matrix with one row per claim with historic payments,
#' generated by [generate_history_per_claim()].
#' @param reinsurance Dataframe with reinsurance information, see details of [xl_cashflow()] or [reinsurance_xmpl]. Default: NULL\cr
#' Only necessary if reinsurance shall be considered.
#' @param indices Dataframe for indexation, see details of [prepare_data()].
#' @param first_orig_year First origin year with complete history.
#' @param last_orig_year Last origin year.
#'
#' @returns
#' List with eight results matrices for large claims. Each matrix consist of one row per
#' development year between `first_orig_year` and `last_orig_year`. Matrices with suffix `...payments` consist of
#' one column for each historic calendar year between `first_orig_year` and `last_orig_year` and 250 predicted
#' calendar years. Matrices with suffix `...reserved` only contain the historic part as no reserves are predicted. \cr
#' 1. `large_claims_payments` with historic and predicted claim payments (e.g. without annuities).
#' 2. `large_claims_reserved` with historic claim reserves (without annuities).
#' 3. `large_known_annuities_payments` with historic and predicted payments for known annuities.
#' 4. `large_annuities_reserved` with historic annuities' reserves.
#' 5. `large_future_annuities_payments` with predicted payments for future annuities, the historic part is all 0.
#' 6. `large_ibnr_payments` with predicted payments for future annuities, the historic part is all 0.
#' 7. `large_ceded_xl_payments` with historic and predicted reinsurance payments for xl treaties.
#' 8. `large_ceded_quota_payments` with historic and predicted reinsurance payments for quota share treaties. \cr \cr
#'
#' Note that there are no reserves for future annuities and ibnr. reserved triangles for reinsurance are often not available,
#' so they are not included here. \cr
#' As no reserves are predicted (only reserve classes), the index clause in xl treaties can only be an approximation, so
#' the results of matrix 7 will probably not correspond exactly to existing xl triangles.
#'
#'
#' @export
#'
#' @examples
#' # this example uses data provided with this package
#' extended_claims_data <- prepare_data(claims_data = claims_data_xmpl,
#'                                      indices = indices_xmpl,
#'                                      threshold = 400000,
#'                                      first_orig_year = 1989,
#'                                      last_orig_year = 2023,
#'                                      expected_year_of_growing_large = 3,
#'                                      reserve_classes = c(1, 200001, 400001, 700001, 1400001),
#'                                      pool_of_annuities = pool_of_annuities_xmpl)
#'
#' pools <- generate_pools(extended_claims_data = extended_claims_data,
#'                         reserve_classes = c(1, 200001, 400001, 700001, 1400001),
#'                         years_for_pools = 2014:2023,
#'                         start_of_tail = 17,
#'                         end_of_tail = 50,
#'                         lower_outlier_limit = -Inf,
#'                         upper_outlier_limit = Inf,
#'                         pool_of_annuities = pool_of_annuities_xmpl)
#'
#' large_claims_list <- generate_claims_list(extended_claims_data = extended_claims_data,
#'                                           first_orig_year = 1989,
#'                                           last_orig_year = 2023)
#'
#' history <- generate_history_per_claim(data = extended_claims_data,
#'                                       column = "Cl_payment_cal",
#'                                       first_orig_year = 1989,
#'                                       last_orig_year = 2023)
#' # smallest version
#' result <- sicr(n = 1,
#'                large_claims_list = large_claims_list,
#'                first_orig_year = 1989,
#'                last_orig_year = 2023,
#'                pools = pools,
#'                indices = indices_xmpl,
#'                history = history)
#'
#' aggregate_large_claims_results(sim_result = result,
#'                                large_claims_list = large_claims_list,
#'                                large_extended_claims_data = extended_claims_data,
#'                                history = history,
#'                                indices = indices_xmpl,
#'                                first_orig_year = 1989,
#'                                last_orig_year = 2023)
aggregate_large_claims_results <- function(sim_result,
                                           large_claims_list,
                                           large_extended_claims_data,
                                           history,
                                           reinsurance = NULL,
                                           indices,
                                           first_orig_year,
                                           last_orig_year) {
   # rows of known claims
   ind_known_claims <- 1:NROW(large_claims_list)


   # empty triangle and prediction is used where not data is available
   empty_triangle <- skeleton_triangle(first_orig_year = first_orig_year,
                                       last_orig_year = last_orig_year)
   empty_prediction <- skeleton_prediction(first_orig_year = first_orig_year,
                                           last_orig_year = last_orig_year)



   ##### Large Claims #####
   # Claims (without annuities)
   large_claims_paid <- generate_triangle(data = large_extended_claims_data,
                                                   col_name = "Cl_payment_cal",
                                                   first_orig_year = first_orig_year,
                                                   last_orig_year = last_orig_year)

   large_claims_reserved <- generate_triangle(data = large_extended_claims_data,
                                              col_name = "Cl_reserve",
                                              first_orig_year = first_orig_year,
                                              last_orig_year = last_orig_year)

   large_claims_prediction <- convert_single2dev_year_prediction(cashflow = sim_result[ind_known_claims,,3],
                                                                 claims_orig_years = large_claims_list$Origin_year,
                                                                 first_orig_year = first_orig_year,
                                                                 last_orig_year = last_orig_year)

   large_claims_payments <- cbind(large_claims_paid, large_claims_prediction)


   # Known annuities
   large_annuities_paid <- generate_triangle(data = large_extended_claims_data,
                                                      col_name = "An_payment_cal",
                                                      first_orig_year = first_orig_year,
                                                      last_orig_year = last_orig_year)

   large_annuities_reserved <- generate_triangle(data = large_extended_claims_data,
                                                 col_name = "An_reserve",
                                                 first_orig_year = first_orig_year,
                                                 last_orig_year = last_orig_year)

   large_known_annuities_prediction <- convert_single2dev_year_prediction(cashflow = sim_result[ind_known_claims,,4],
                                                                          claims_orig_years = large_claims_list$Origin_year,
                                                                          first_orig_year = first_orig_year,
                                                                          last_orig_year = last_orig_year)

   large_known_annuities_payments <- cbind(large_annuities_paid, large_known_annuities_prediction)


   # Future annuities
   large_future_annuities_prediction <- convert_single2dev_year_prediction(cashflow = sim_result[ind_known_claims,,5],
                                                                           claims_orig_years = large_claims_list$Origin_year,
                                                                           first_orig_year = first_orig_year,
                                                                           last_orig_year = last_orig_year)

   large_future_annuities_payments <- cbind(empty_triangle, large_future_annuities_prediction)


   # ibnr
   ibnr_list <- attr(sim_result, "ibnr_list")
   if (NROW(ibnr_list) == 0) {
      large_ibnr_payments <- cbind(empty_triangle, empty_prediction)
   } else {
      ind_ibnr <- (NROW(large_claims_list) + 1):NROW(sim_result)
      large_ibnr_payments <- cbind(empty_triangle,
                                   convert_single2dev_year_prediction(cashflow = sim_result[ind_ibnr,,1],
                                                                      claims_orig_years = ibnr_list$Origin_year,
                                                                      first_orig_year = first_orig_year,
                                                                      last_orig_year = last_orig_year))
   }


   # reinsurance
   if (!is.null(reinsurance)) {
      large_ceded_xl_per_claim_history <- xl_cashflow(future_payments = matrix(0, nrow = NROW(large_claims_list), ncol = 250),
                                                      claims_list = large_claims_list,
                                                      history = history,
                                                      reinsurance = reinsurance,
                                                      indices = indices,
                                                      output = "history")

      # xl
      large_ceded_xl_paid <- convert_single2dev_year_triangle(cashflow = large_ceded_xl_per_claim_history,
                                                                       claims_orig_years = large_claims_list$Origin_year,
                                                                       first_orig_year = first_orig_year,
                                                                       last_orig_year = last_orig_year)

      large_ceded_xl_prediction <- convert_single2dev_year_prediction(cashflow = sim_result[ind_known_claims,,6],
                                                                      claims_orig_years = large_claims_list$Origin_year,
                                                                      first_orig_year = first_orig_year,
                                                                      last_orig_year = last_orig_year)

      large_ceded_xl_payments <- cbind(large_ceded_xl_paid, large_ceded_xl_prediction)


      # quota share
      large_ceded_quota_payments <- (large_claims_payments +
                                        large_known_annuities_payments +
                                        large_future_annuities_payments +
                                        large_ibnr_payments) *
         reinsurance$Quota_share[reinsurance$Origin_year %in% first_orig_year:last_orig_year]
   } else {
      large_ceded_xl_payments <- large_ceded_quota_payments <- cbind(empty_triangle, empty_prediction)
   }

   return(list(large_claims_payments = large_claims_payments,
               large_claims_reserved = large_claims_reserved,
               large_known_annuities_payments = large_known_annuities_payments,
               large_annuities_reserved = large_annuities_reserved,
               large_future_annuities_payments = large_future_annuities_payments,
               large_ibnr_payments = large_ibnr_payments,
               large_ceded_xl_payments = large_ceded_xl_payments,
               large_ceded_quota_payments = large_ceded_quota_payments))
}
